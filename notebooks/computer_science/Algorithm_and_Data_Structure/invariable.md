不变量笔记：结构不变量、单调不变量与进度量（以稳定匹配为例）
0. 为什么要学“不变量”

算法分析里常见三类证明目标：

正确性：算法输出满足问题定义（可行、最优或稳定等）

终止性：算法一定会停，不会死循环

复杂度上界：最多执行多少步 / 多快停

这三类证明的核心工具就是 不变量（Invariant） 体系：

正确性通常靠 结构不变量

终止性与迭代次数上界通常靠 单调不变量 / 进度量

1. 不变量（Invariant）是什么
1.1 定义（通用）

不变量：在算法执行的每一步之后都成立的性质 / 约束。

更形式化：

设算法状态为 S(t)（第 t 步后的状态）

性质 I(·) 若满足：

I(S(0)) 成立（初始成立）

若 I(S(t)) 成立，则执行一步后 I(S(t+1)) 仍成立（保持性）

则 I 是算法不变量

1.2 不变量的功能

约束算法“能做什么”

确保中间状态始终合法

为最终结果性质提供桥梁（从每一步都对 → 最终也对）

2. 结构不变量（Structural Invariant）
2.1 定义

结构不变量：算法执行过程中始终被保持的“关系结构、约束形态或可行性框架”。

它通常不要求单调变化，只要求不被破坏。

2.2 结构不变量的典型作用

保证中间状态始终是一个合法解（或合法部分解）

保证数据结构或数学结构始终保持定义（匹配、流、树、DAG 等）

2.3 稳定匹配中的结构不变量（Gale–Shapley）

常见结构不变量包括：

匹配结构合法：任何女人最多订婚给一个男人；任何男人最多与一个女人订婚（当前订婚关系始终是一对一）

订婚关系来自偏好表：订婚只发生在男人向女人求婚后

女人当前订婚对象总是她见过的求婚者中最优的
（女人只会“升级”，不会从更喜欢的人换回更不喜欢的人）

注意：这些性质保证了算法过程始终在“合法结构空间”中运行，但它们不一定能直接给出迭代次数上界。

3. 单调不变量（Monotonic Invariant）
3.1 定义

单调不变量：一种特殊的不变量，它在算法每一步都会沿某个方向严格单调变化，且不可逆。

通常要满足：

保持性：每一步后仍定义良好，语义不变

单调性：每一步都严格增加或严格减少

不可逆：一旦变化就不会回退

单调不变量经常被用来证明：算法一定终止，并能给出迭代次数上界。

3.2 “能描述状态”不等于“能做单调不变量”

很多直觉量是“状态描述量”，会停滞或震荡，例如：

当前自由人数（可能不变）

当前订婚对数（可能不变）

当前匹配规模（可能不变或来回变化）

这些量不保证每一步严格向前，因此很难用于“迭代次数上界”证明。

4. 进度量（Progress Measure / Potential Function）
4.1 定义

进度量：把“单调不变量”数值化后的指标，用于计数迭代次数上界。

典型形式：一个整数值函数 Φ(t)，满足：

Φ(t+1) > Φ(t)（严格增加）或 Φ(t+1) < Φ(t)（严格减少）

Φ 有明确的上界/下界

于是迭代次数 ≤ 上界变化次数。

5. 例子：为什么 P(t) 是单调不变量（稳定匹配）
5.1 定义 P(t)

设有 n 个男人、n 个女人。算法每轮让某个自由男人向一个女人求婚（且同一对 (m,w) 不会重复求婚）。

定义：

P(t)：第 t 次迭代结束时，所有已经发生过求婚的 (m,w) 对的集合

形式化：

P(t) = { (m, w) | m 在第 t 步结束前曾经向 w 求过婚 }

关键点：P(t) 记录的是“曾经发生过”的历史事实，不是当前订婚状态。

5.2 为什么它“不依赖路径、不依赖当前匹配状态”

不依赖路径：
不管算法以什么顺序发生求婚，只要到 t 时刻“发生过的求婚对集合”一样，P(t) 就一样。
P(t) 只看“发生过哪些求婚”，不看“这些求婚按什么顺序发生”。

不依赖当前匹配状态：
当前谁和谁订婚、谁被甩、谁自由——都不会改变“某次求婚曾经发生过”这个历史事实。
所以 P(t) 不关心当前配对局面，只关心“已消耗过哪些可能性”。

5.3 单调性证明（每步严格增加）

Gale–Shapley 的关键规则：

每一次迭代，都会发生一个求婚

且该求婚是男人第一次向该女人求婚（不会重复）

因此从 t 到 t+1：

P(t+1) = P(t) ∪ { (m, w) }，其中 (m, w) ∉ P(t)

所以：

|P(t+1)| = |P(t)| + 1

结论：|P(t)| 每步严格增加 → 这是严格单调性。

5.4 不可逆性证明

一旦 (m, w) 发生过求婚，它就永远属于“发生过求婚”的集合，不会被删除：

即使后面订婚 / 分手 / 再订婚

也不会改变“曾经求过婚”的事实

所以：

(m, w) ∈ P(t) ⇒ (m, w) ∈ P(t′) 对所有 t′ > t

5.5 上界：为什么最多 n² 步

所有可能的男女对最多有：

n × n = n²

而 |P(t)| 每次只 +1，最多加到 n²，因此最多迭代 n² 次。

6. 一句话总结四个概念的分工

结构不变量：保证过程始终合法（不能乱走）

单调不变量：保证过程不可逆推进（不会白走）

进度量：把单调推进“计数化”，从而得到迭代次数上界

状态量：描述当前局面，但可能震荡，通常不能直接用于迭代上界证明

7. 构造不变量的实用模板（可复用）
7.1 找结构不变量（正确性）

问自己：

算法每一步之后，哪些约束必须始终成立才“不会出界”？

合法解 / 合法部分解的定义是什么？中间状态是否一直保持？

哪些关系结构（匹配/流/树/拓扑）必须保持？

7.2 找单调不变量（终止 + 上界）

问自己：

每一步是否必然“永久消耗”某种资源/选择？

有没有一个“历史事实集合”不断增加（或减少）？

这个集合/数值是否有天然上界（例如 n²、m、容量总和等）？

经验法则：

不要盯“当前状态”（容易震荡）

盯“不可逆的历史消耗”（更容易单调）

8. 你可以直接背下来的核心句

好的不变量通常描述“结构边界”，
好的单调不变量通常描述“不可逆的搜索空间消耗”，
进度量就是把这种消耗计数化，从而得到终止与复杂度上界